<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="691px" preserveAspectRatio="none" style="width:987px;height:691px;background:#FFFFFF;" version="1.1" viewBox="0 0 987 691" width="987px" zoomAndPan="magnify"><defs><filter height="300%" id="f81ew2q3pej4b" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="146" x2="146" y1="53.4883" y2="634.3887"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="746" x2="746" y1="53.4883" y2="634.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="116" y="50.5352">Initiator</text><ellipse cx="146" cy="21" fill="#FEFECE" filter="url(#f81ew2q3pej4b)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="134" x2="158" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="116" y="646.9238">Initiator</text><ellipse cx="146" cy="665.877" fill="#FEFECE" filter="url(#f81ew2q3pej4b)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="134" x2="158" y1="679.877" y2="679.877"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="706" y="50.5352">Responder</text><ellipse cx="746" cy="21" fill="#FEFECE" filter="url(#f81ew2q3pej4b)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="734" x2="758" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="706" y="646.9238">Responder</text><ellipse cx="746" cy="665.877" fill="#FEFECE" filter="url(#f81ew2q3pej4b)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="734" x2="758" y1="679.877" y2="679.877"/><polygon fill="#A80036" points="157,80.7988,147,84.7988,157,88.7988,153,84.7988" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="745" y1="84.7988" y2="84.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="400.5" y="80.0566">Stream 1:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="467.5" y="80.0566"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="467.5" y="79.7329">EOF</text><path d="M638,97.7988 L638,122.7988 L849,122.7988 L849,107.7988 L839,97.7988 L638,97.7988 " fill="#FBFB77" filter="url(#f81ew2q3pej4b)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M839,97.7988 L839,107.7988 L849,107.7988 L839,97.7988 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="644" y="115.3672">Stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="708" y="115.3672">is closed for writing</text><rect fill="#EEEEEE" filter="url(#f81ew2q3pej4b)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="980" x="0" y="152.7646"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="980" y1="152.7646" y2="152.7646"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="980" y1="155.7646" y2="155.7646"/><rect fill="#EEEEEE" filter="url(#f81ew2q3pej4b)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="134" x="423" y="142.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="429" y="158.6777">Stream Migration</text><path d="M113,180.4199 L113,205.4199 L778,205.4199 L778,190.4199 L768,180.4199 L113,180.4199 " fill="#FBFB77" filter="url(#f81ew2q3pej4b)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M768,180.4199 L768,190.4199 L778,190.4199 L768,180.4199 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="343" y="197.9883">Migrate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="394" y="197.9883">Stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="458" y="197.9883">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="475" y="197.9883">Stream 2</text><polygon fill="#A80036" points="734,232.041,744,236.041,734,240.041,738,236.041" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="146" x2="740" y1="236.041" y2="236.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="273" y="231.2988">Open new stream on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="89" x="406" y="231.2988">Connection 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="495" y="231.2988">. Call this</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="559" y="231.2988">Stream 2</text><polygon fill="#A80036" points="734,261.3516,744,265.3516,734,269.3516,738,265.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="146" x2="740" y1="265.3516" y2="265.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="158" y="260.6094">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="225" y="260.6094">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="494" y="260.2856">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="734,290.6621,744,294.6621,734,298.6621,738,294.6621" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="146" x2="740" y1="294.6621" y2="294.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="194" y="289.9199">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="261" y="289.9199">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="295" y="289.5962">StreamMigration(type=Migrate(id=2, from=1))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="643" y="289.9199">message</text><polygon fill="#A80036" points="157,319.9727,147,323.9727,157,327.9727,153,323.9727" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="745" y1="323.9727" y2="323.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="375" y="319.2305">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="442" y="319.2305">Ack Migrate</text><path d="M5,336.9727 L5,376.9727 L284,376.9727 L284,346.9727 L274,336.9727 L5,336.9727 " fill="#FBFB77" filter="url(#f81ew2q3pej4b)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M274,336.9727 L274,346.9727 L284,346.9727 L274,336.9727 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="11" y="354.541">Close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="50" y="354.541">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="114" y="354.541">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="11" y="369.8516">Will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="121" y="369.8516">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="185" y="369.8516">from now on.</text><path d="M18,391.5938 L18,446.5938 L269,446.5938 L269,401.5938 L259,391.5938 L18,391.5938 " fill="#FBFB77" filter="url(#f81ew2q3pej4b)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M259,391.5938 L259,401.5938 L269,401.5938 L259,391.5938 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="24" y="409.1621">We have already seen the</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="185" y="408.8384">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="213" y="409.1621">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="24" y="424.4727">Stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="88" y="424.4727">from</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="66" x="122" y="424.4727">Responder</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="24" y="439.7832">So we continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="194" y="439.7832">stream 2</text><polygon fill="#A80036" points="734,473.8359,744,477.8359,734,481.8359,738,477.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="146" x2="740" y1="477.8359" y2="477.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="400.5" y="473.0938">Stream 1:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="467.5" y="473.0938"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="467.5" y="472.77">EOF</text><path d="M516,490.8359 L516,545.8359 L971,545.8359 L971,500.8359 L961,490.8359 L516,490.8359 " fill="#FBFB77" filter="url(#f81ew2q3pej4b)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M961,490.8359 L961,500.8359 L971,500.8359 L961,490.8359 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="32" x="522" y="508.4043">Treat</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="558" y="508.0806">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="586" y="508.4043">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="606" y="508.4043">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="670" y="508.4043">as a signal to close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="795" y="508.4043">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="859" y="508.4043">for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="198" x="522" y="523.7148">writing and continue writing on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="724" y="523.7148">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="784" y="523.7148">. However stream 1 was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="522" y="539.0254">already closed (before migration), so we close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="814" y="539.0254">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="878" y="539.0254">as well here.</text><polygon fill="#A80036" points="157,573.0781,147,577.0781,157,581.0781,153,577.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="745" y1="577.0781" y2="577.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="400.5" y="572.3359">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="467.5" y="572.3359"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="467.5" y="572.0122">EOF</text><path d="M113,590.0781 L113,615.0781 L778,615.0781 L778,600.0781 L768,590.0781 L113,590.0781 " fill="#FBFB77" filter="url(#f81ew2q3pej4b)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M768,590.0781 L768,600.0781 L778,600.0781 L768,590.0781 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="321" y="607.6465">Stream 1 is now migrated to Stream 2</text><!--MD5=[227ee6d082dc0abff24e054e5716f746]
@startuml stream-migration-half-closed
skinparam sequenceMessageAlign center
entity Initiator
entity Responder

Initiator <- Responder: <b>Stream 1:</b> ""EOF""
note over Responder: <b>Stream 1</b> is closed for writing

== Stream Migration ==

note over Initiator, Responder: Migrate <b>Stream 1</b> to <b>Stream 2</b>

Initiator -> Responder: Open new stream on <b>Connection 2</b>. Call this <b>Stream 2</b>

Initiator -> Responder: <b>Stream 2:</b> Negotiate stream-migration protocol with ""<stream-migration protocol id>""
Initiator -> Responder: <b>Stream 2:</b> Send ""StreamMigration(type=Migrate(id=2, from=1))"" message

Initiator <- Responder: <b>Stream 2:</b> Ack Migrate

note over Initiator
    Close <b>stream 1</b> for writing.
    Will only write to <b>stream 2</b> from now on.
end note

note over Initiator
    We have already seen the ""EOF"" on
    <b>Stream 1</b> from <i>Responder</i>
    So we continue reading on <b>stream 2</b>
end note

Initiator -> Responder: <b>Stream 1:</b> ""EOF""

note over Responder
    Treat ""EOF"" on <b>stream 1</b> as a signal to close <b>stream 1</b> for
    writing and continue writing on <b>stream 2</b>. However stream 1 was
    already closed (before migration), so we close <b>stream 2</b> as well here.
end note
Initiator <- Responder: <b>Stream 2:</b> ""EOF""

note over Initiator, Responder: Stream 1 is now migrated to Stream 2

@enduml

PlantUML version 1.2021.12(Tue Oct 05 18:01:58 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>