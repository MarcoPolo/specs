<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="965px" preserveAspectRatio="none" style="width:854px;height:965px;background:#FFFFFF;" version="1.1" viewBox="0 0 854 965" width="854px" zoomAndPan="magnify"><defs><filter height="300%" id="fl7fnlifxvkyw" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="157" y1="53.4883" y2="295.1055"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="157" x2="157" y1="295.1055" y2="336.0605"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="157" y1="336.0605" y2="908.2715"/><line style="stroke:#A80036;stroke-width:1.0;" x1="690" x2="690" y1="53.4883" y2="295.1055"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="690" x2="690" y1="295.1055" y2="336.0605"/><line style="stroke:#A80036;stroke-width:1.0;" x1="690" x2="690" y1="336.0605" y2="908.2715"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="127" y="50.5352">Initiator</text><ellipse cx="157" cy="21" fill="#FEFECE" filter="url(#fl7fnlifxvkyw)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="145" x2="169" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="127" y="920.8066">Initiator</text><ellipse cx="157" cy="939.7598" fill="#FEFECE" filter="url(#fl7fnlifxvkyw)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="145" x2="169" y1="953.7598" y2="953.7598"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="650" y="50.5352">Responder</text><ellipse cx="690" cy="21" fill="#FEFECE" filter="url(#fl7fnlifxvkyw)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="678" x2="702" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="650" y="920.8066">Responder</text><ellipse cx="690" cy="939.7598" fill="#FEFECE" filter="url(#fl7fnlifxvkyw)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="678" x2="702" y1="953.7598" y2="953.7598"/><path d="M124,68.4883 L124,139.4883 L722,139.4883 L722,78.4883 L712,68.4883 L124,68.4883 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,68.4883 L712,78.4883 L722,78.4883 L712,68.4883 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="315" x="224.5" y="86.0566">Assume both sides understand stream-migration.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="304" x="224.5" y="101.3672">Also Assume Initiator has the lower peer ID, and</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="384" x="224.5" y="116.1763">Hash(PeerID(Initiator)+PeerID(responder))%2 == 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="228.5" y="131.8105"/><polygon fill="#A80036" points="678,165.8633,688,169.8633,678,173.8633,682,169.8633" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="169.8633" y2="169.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="370" y="165.1211">Open connection</text><polygon fill="#A80036" points="678,195.1738,688,199.1738,678,203.1738,682,199.1738" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="199.1738" y2="199.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="344" y="194.4316">Open multiplexed stream</text><polygon fill="#A80036" points="678,224.4844,688,228.4844,678,232.4844,682,228.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="228.4844" y2="228.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="169" y="223.7422">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="438" y="223.4185">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="678,253.7949,688,257.7949,678,261.7949,682,257.7949" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="257.7949" y2="257.7949"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="245" y="253.0527">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="264" x="279" y="252.729">StreamMigration(type=Label(id=0))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="547" y="253.0527">message</text><polygon fill="#A80036" points="678,283.1055,688,287.1055,678,291.1055,682,287.1055" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="287.1055" y2="287.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="259" x="294" y="282.3633">continue negotiating underlying protocol</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="337.5" y="319.7402"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="172" x="337.5" y="319.7402">Nodes use the stream as normal</text><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="0" x="512.5" y="319.7402"/><rect fill="#EEEEEE" filter="url(#fl7fnlifxvkyw)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="847" x="0" y="356.7158"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="847" y1="356.7158" y2="356.7158"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="847" y1="359.7158" y2="359.7158"/><rect fill="#EEEEEE" filter="url(#fl7fnlifxvkyw)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="134" x="356.5" y="346.0605"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="362.5" y="362.6289">Stream Migration</text><path d="M124,384.3711 L124,409.3711 L722,409.3711 L722,394.3711 L712,384.3711 L124,384.3711 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,384.3711 L712,394.3711 L722,394.3711 L712,384.3711 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="320.5" y="401.9395">Migrate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="371.5" y="401.9395">Stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="435.5" y="401.9395">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="452.5" y="401.9395">Stream 2</text><polygon fill="#A80036" points="678,435.9922,688,439.9922,678,443.9922,682,439.9922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="439.9922" y2="439.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="369" y="435.25">Open new stream</text><polygon fill="#A80036" points="678,465.3027,688,469.3027,678,473.3027,682,469.3027" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="469.3027" y2="469.3027"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="169" y="464.5605">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="438" y="464.2368">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="678,494.6133,688,498.6133,678,502.6133,682,498.6133" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="498.6133" y2="498.6133"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="171.5" y="493.8711">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="238.5" y="493.8711">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="272.5" y="493.5474">StreamMigration(type=Migrate(id=2, from=0))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="620.5" y="493.8711">message</text><polygon fill="#A80036" points="168,523.9238,158,527.9238,168,531.9238,164,527.9238" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="162" x2="689" y1="527.9238" y2="527.9238"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="308" y="523.1816">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="375" y="523.1816">Send AckMigrate message</text><path d="M538,540.9238 L538,580.9238 L838,580.9238 L838,550.9238 L828,540.9238 L538,540.9238 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M828,540.9238 L828,550.9238 L838,550.9238 L828,540.9238 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="544" y="558.4922">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="606" y="558.1685">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="634" y="558.4922">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="654" y="558.4922">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="718" y="558.4922">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="544" y="573.8027">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="763" y="573.8027">stream 2</text><path d="M15,595.5449 L15,635.5449 L294,635.5449 L294,605.5449 L284,595.5449 L15,595.5449 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M284,595.5449 L284,605.5449 L294,605.5449 L284,595.5449 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="21" y="613.1133">Close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="60" y="613.1133">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="124" y="613.1133">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="21" y="628.4238">Will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="131" y="628.4238">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="195" y="628.4238">from now on.</text><polygon fill="#A80036" points="678,662.4766,688,666.4766,678,670.4766,682,666.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="666.4766" y2="666.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="378" y="661.7344">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="445" y="661.7344"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="445" y="661.4106">EOF</text><path d="M542,679.4766 L542,734.4766 L833,734.4766 L833,689.4766 L823,679.4766 L542,679.4766 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M823,679.4766 L823,689.4766 L833,689.4766 L823,679.4766 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="548" y="697.0449">When</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="66" x="586" y="697.0449">Responder</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="656" y="697.0449">reads</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="694" y="696.7212">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="722" y="697.0449">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="742" y="697.0449">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="548" y="712.3555">it will close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="624" y="712.3555">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="688" y="712.3555">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="548" y="727.666">It will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="670" y="727.666">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="734" y="727.666">from now on.</text><polygon fill="#A80036" points="168,761.7188,158,765.7188,168,769.7188,164,765.7188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="162" x2="689" y1="765.7188" y2="765.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="378" y="760.9766">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="445" y="760.9766"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="445" y="760.6528">EOF</text><path d="M5,778.7188 L5,818.7188 L305,818.7188 L305,788.7188 L295,778.7188 L5,778.7188 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M295,778.7188 L295,788.7188 L305,788.7188 L295,778.7188 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="11" y="796.2871">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="73" y="795.9634">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="101" y="796.2871">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="121" y="796.2871">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="185" y="796.2871">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="11" y="811.5977">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="230" y="811.5977">stream 2</text><path d="M124,833.3398 L124,888.3398 L722,888.3398 L722,843.3398 L712,833.3398 L124,833.3398 " fill="#FBFB77" filter="url(#fl7fnlifxvkyw)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,833.3398 L712,843.3398 L722,843.3398 L712,833.3398 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="266.5" y="850.9082">At this point</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="349.5" y="850.9082">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="413.5" y="850.9082">is closed for writing on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="266.5" y="866.2188">both sides, and both sides have read up to</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="538.5" y="865.895">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="562.5" y="866.2188">.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="266.5" y="881.5293">stream 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="330.5" y="881.5293">has been fully migrated to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="499.5" y="881.5293">stream 2</text><!--MD5=[7a9d9fd18c6764912684d53e895c99bc]
@startuml stream-migration
skinparam sequenceMessageAlign center
entity Initiator
entity Responder

note over Initiator, Responder
    Assume both sides understand stream-migration.
    Also Assume Initiator has the lower peer ID, and
    ""Hash(PeerID(Initiator)+PeerID(responder))%2 == 0""

end note

Initiator -> Responder: Open connection
Initiator -> Responder: Open multiplexed stream

Initiator -> Responder: Negotiate stream-migration protocol with ""<stream-migration protocol id>""

Initiator -> Responder: Send ""StreamMigration(type=Label(id=0))"" message

Initiator -> Responder: <i> continue negotiating underlying protocol </i>
... <i>Nodes use the stream as normal<i> ...

== Stream Migration ==

note over Initiator, Responder: Migrate <b>Stream 0</b> to <b>Stream 2</b>

Initiator -> Responder: Open new stream
Initiator -> Responder: Negotiate stream-migration protocol with ""<stream-migration protocol id>""

Initiator -> Responder: <b>Stream 2:</b> Send ""StreamMigration(type=Migrate(id=2, from=0))"" message

Initiator <- Responder: <b>Stream 2:</b> Send AckMigrate message

note over Responder
    Treat any ""EOF"" on <b>stream 0</b> as a signal
    that it should continue reading on <b>stream 2</b>
end note


note over Initiator
    Close <b>stream 0</b> for writing.
    Will only write to <b>stream 2</b> from now on.
end note

Initiator -> Responder: <b>Stream 2:</b> ""EOF""

note over Responder
    When <i>Responder</i> reads ""EOF"" on <b>stream 0</b>
    it will close <b>stream 0</b> for writing.
    It will only write to <b>stream 2</b> from now on.
end note

Initiator <- Responder: <b>Stream 2:</b> ""EOF""

note over Initiator
    Treat any ""EOF"" on <b>stream 0</b> as a signal
    that it should continue reading on <b>stream 2</b>
end note

note over Initiator, Responder
    At this point <b>stream 0</b> is closed for writing on
    both sides, and both sides have read up to ""EOF"".
    <b>stream 0</b> has been fully migrated to <b>stream 2</b>
end note

@enduml

PlantUML version 1.2021.12(Tue Oct 05 18:01:58 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>