<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1162px" preserveAspectRatio="none" style="width:1102px;height:1162px;background:#FFFFFF;" version="1.1" viewBox="0 0 1102 1162" width="1102px" zoomAndPan="magnify"><defs><filter height="300%" id="f1n9rb7y51t00i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1n9rb7y51t00i)" height="255.084" style="stroke:#000000;stroke-width:2.0;" width="1076" x="9" y="243.9961"/><rect fill="#FFFFFF" height="73.5762" style="stroke:none;stroke-width:1.0;" width="1076" x="9" y="425.5039"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="275" y1="53.4883" y2="92.7988"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="275" x2="275" y1="92.7988" y2="133.7539"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="275" y1="133.7539" y2="384.5488"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="275" x2="275" y1="384.5488" y2="425.5039"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="275" y1="425.5039" y2="506.0801"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="275" x2="275" y1="506.0801" y2="547.0352"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="275" y1="547.0352" y2="1105.0684"/><line style="stroke:#A80036;stroke-width:1.0;" x1="883" x2="883" y1="53.4883" y2="92.7988"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="883" x2="883" y1="92.7988" y2="133.7539"/><line style="stroke:#A80036;stroke-width:1.0;" x1="883" x2="883" y1="133.7539" y2="384.5488"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="883" x2="883" y1="384.5488" y2="425.5039"/><line style="stroke:#A80036;stroke-width:1.0;" x1="883" x2="883" y1="425.5039" y2="506.0801"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="883" x2="883" y1="506.0801" y2="547.0352"/><line style="stroke:#A80036;stroke-width:1.0;" x1="883" x2="883" y1="547.0352" y2="1105.0684"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="245" y="50.5352">Initiator</text><ellipse cx="275" cy="21" fill="#FEFECE" filter="url(#f1n9rb7y51t00i)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="263" x2="287" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="245" y="1117.6035">Initiator</text><ellipse cx="275" cy="1136.5566" fill="#FEFECE" filter="url(#f1n9rb7y51t00i)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="263" x2="287" y1="1150.5566" y2="1150.5566"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="843" y="50.5352">Responder</text><ellipse cx="883" cy="21" fill="#FEFECE" filter="url(#f1n9rb7y51t00i)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="871" x2="895" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="843" y="1117.6035">Responder</text><ellipse cx="883" cy="1136.5566" fill="#FEFECE" filter="url(#f1n9rb7y51t00i)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="871" x2="895" y1="1150.5566" y2="1150.5566"/><polygon fill="#A80036" points="871,80.7988,881,84.7988,871,88.7988,875,84.7988" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="84.7988" y2="84.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="525.5" y="80.0566">Open connection</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="450.5" y="117.4336"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="257" x="450.5" y="117.4336">Establish both sides support multistream-select</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="710.5" y="117.4336"/><polygon fill="#A80036" points="871,151.0645,881,155.0645,871,159.0645,875,155.0645" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="155.0645" y2="155.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="499.5" y="150.3223">Open multiplexed stream</text><polygon fill="#A80036" points="871,195.6855,881,199.6855,871,203.6855,875,199.6855" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="199.6855" y2="199.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="394" y="179.6328">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="336" x="428" y="179.3091">&lt;stream-migration protocol id&gt;/&lt;stream-id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="473.5" y="194.9434">e.g.</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="500.5" y="194.6196">streamMigration/1.0.0/A</text><polygon fill="#A80036" points="871,224.9961,881,228.9961,871,232.9961,875,228.9961" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="228.9961" y2="228.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="406.5" y="224.2539">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="440.5" y="223.9302">&lt;user-protocol-id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="588.5" y="224.2539">(as-in multistream select)</text><path d="M9,243.9961 L71,243.9961 L71,250.9961 L61,260.9961 L9,260.9961 L9,243.9961 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="255.084" style="stroke:#000000;stroke-width:2.0;" width="1076" x="9" y="243.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="24" y="257.5645">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="224" x="86" y="256.6309">[Responder supports stream-migration]</text><polygon fill="#A80036" points="286,278.6172,276,282.6172,286,286.6172,282,282.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="280" x2="882" y1="282.6172" y2="282.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="389.5" y="277.875">Echo back</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="457.5" y="277.5513">&lt;user-protocol-id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="605.5" y="277.875">(as-in multistream select)</text><path d="M19,295.6172 L19,335.6172 L526,335.6172 L526,305.6172 L516,295.6172 L19,295.6172 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M516,295.6172 L516,305.6172 L526,305.6172 L516,295.6172 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="486" x="25" y="313.1855">The initiator knows the peer supports stream-migration since it echoed back</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="25" y="328.4961">the user protocol.</text><path d="M690,350.2383 L690,375.2383 L1071,375.2383 L1071,360.2383 L1061,350.2383 L690,350.2383 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1061,350.2383 L1061,360.2383 L1071,360.2383 L1061,350.2383 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="696" y="367.8066">The responder knows that this stream is called</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="995" y="367.8066">stream A</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="475.5" y="409.1836"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="207" x="475.5" y="409.1836">Continue negotiating another protocol</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="685.5" y="409.1836"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="9" x2="1085" y1="426.5039" y2="426.5039"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="93" x="14" y="437.1387">[Responder does</text><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="18" x="111" y="437.1387">not</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="157" x="133" y="437.1387">supports stream-migration]</text><polygon fill="#A80036" points="286,457.7695,276,461.7695,286,465.7695,282,461.7695" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="280" x2="882" y1="461.7695" y2="461.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="472" x="343" y="457.0273">send back "na" for the stream-migration protocol (like multistream-select)</text><polygon fill="#A80036" points="286,487.0801,276,491.0801,286,495.0801,282,491.0801" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="280" x2="882" y1="491.0801" y2="491.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="389.5" y="486.3379">Echo back</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="457.5" y="486.0142">&lt;user-protocol-id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="605.5" y="486.3379">(as-in multistream select)</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="493" y="530.7148"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="172" x="493" y="530.7148">Nodes use the stream as normal</text><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="0" x="668" y="530.7148"/><rect fill="#EEEEEE" filter="url(#f1n9rb7y51t00i)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1095" x="0" y="567.6904"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1095" y1="567.6904" y2="567.6904"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1095" y1="570.6904" y2="570.6904"/><rect fill="#EEEEEE" filter="url(#f1n9rb7y51t00i)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="134" x="480.5" y="557.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="486.5" y="573.6035">Stream Migration</text><path d="M242,595.3457 L242,620.3457 L915,620.3457 L915,605.3457 L905,595.3457 L242,595.3457 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M905,595.3457 L905,605.3457 L915,605.3457 L905,595.3457 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="476" y="612.9141">Migrate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="527" y="612.9141">Stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="592" y="612.9141">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="609" y="612.9141">Stream B</text><polygon fill="#A80036" points="871,646.9668,881,650.9668,871,654.9668,875,650.9668" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="650.9668" y2="650.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="406.5" y="646.2246">Open new stream on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="89" x="539.5" y="646.2246">Connection 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="628.5" y="646.2246">. Call this</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="692.5" y="646.2246">Stream B</text><polygon fill="#A80036" points="871,691.4102,881,695.4102,871,699.4102,875,695.4102" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="695.4102" y2="695.4102"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="584" x="287" y="675.0337">&lt;stream-migration protocol id&gt;/&lt;this-stream-id&gt;/from/&lt;original-stream-id&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="445.5" y="690.668">e.g.</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="472.5" y="690.3442">streamMigration/1.0.0/B/from/A</text><polygon fill="#A80036" points="286,720.7207,276,724.7207,286,728.7207,282,724.7207" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="280" x2="882" y1="724.7207" y2="724.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="62" x="508.5" y="719.9785">Stream B:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="574.5" y="719.9785">Ack Migrate</text><path d="M731,737.7207 L731,777.7207 L1030,777.7207 L1030,747.7207 L1020,737.7207 L731,737.7207 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1020,737.7207 L1020,747.7207 L1030,747.7207 L1020,737.7207 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="737" y="755.2891">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="799" y="754.9653">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="827" y="755.2891">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="847" y="755.2891">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="912" y="755.2891">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="737" y="770.5996">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="956" y="770.5996">stream B</text><path d="M134,792.3418 L134,832.3418 L412,832.3418 L412,802.3418 L402,792.3418 L134,792.3418 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M402,792.3418 L402,802.3418 L412,802.3418 L402,792.3418 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="140" y="809.9102">Close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="179" y="809.9102">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="244" y="809.9102">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="140" y="825.2207">Will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="250" y="825.2207">stream B</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="313" y="825.2207">from now on.</text><polygon fill="#A80036" points="871,859.2734,881,863.2734,871,867.2734,875,863.2734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="275" x2="877" y1="863.2734" y2="863.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="64" x="533" y="858.5313">Stream A:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="601" y="858.5313"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="601" y="858.2075">EOF</text><path d="M736,876.2734 L736,931.2734 L1026,931.2734 L1026,886.2734 L1016,876.2734 L736,876.2734 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1016,876.2734 L1016,886.2734 L1026,886.2734 L1016,876.2734 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="742" y="893.8418">When</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="66" x="780" y="893.8418">Responder</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="850" y="893.8418">reads</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="888" y="893.5181">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="916" y="893.8418">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="936" y="893.8418">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="742" y="909.1523">it will close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="818" y="909.1523">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="883" y="909.1523">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="742" y="924.4629">It will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="864" y="924.4629">stream B</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="927" y="924.4629">from now on.</text><polygon fill="#A80036" points="286,958.5156,276,962.5156,286,966.5156,282,962.5156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="280" x2="882" y1="962.5156" y2="962.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="64" x="533" y="957.7734">Stream A:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="601" y="957.7734"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="601" y="957.4497">EOF</text><path d="M123,975.5156 L123,1015.5156 L422,1015.5156 L422,985.5156 L412,975.5156 L123,975.5156 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M412,975.5156 L412,985.5156 L422,985.5156 L412,975.5156 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="129" y="993.084">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="191" y="992.7603">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="219" y="993.084">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="239" y="993.084">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="304" y="993.084">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="129" y="1008.3945">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="348" y="1008.3945">stream B</text><path d="M242,1030.1367 L242,1085.1367 L915,1085.1367 L915,1040.1367 L905,1030.1367 L242,1030.1367 " fill="#FBFB77" filter="url(#f1n9rb7y51t00i)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M905,1030.1367 L905,1040.1367 L915,1040.1367 L905,1030.1367 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="422" y="1047.7051">At this point</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="505" y="1047.7051">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="570" y="1047.7051">is closed for writing on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="422" y="1063.0156">both sides, and both sides have read up to</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="694" y="1062.6919">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="718" y="1063.0156">.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="422" y="1078.3262">stream A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="487" y="1078.3262">has been fully migrated to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="59" x="656" y="1078.3262">stream B</text><!--MD5=[068ed98615fedec634bec7d0f955980e]
@startuml stream-migration
skinparam sequenceMessageAlign center
entity Initiator
entity Responder

' note over Initiator, Responder: Assume at least 2 connections.

Initiator -> Responder: Open connection
... <i>Establish both sides support multistream-select</i> ...

Initiator -> Responder: Open multiplexed stream

Initiator -> Responder: Send ""<stream-migration protocol id>/<stream-id>""\ne.g. ""streamMigration/1.0.0/A""
Initiator -> Responder: Send ""<user-protocol-id>"" (as-in multistream select)

alt Responder supports stream-migration
  Initiator <- Responder: Echo back ""<user-protocol-id>"" (as-in multistream select)
  note over Initiator
   The initiator knows the peer supports stream-migration since it echoed back
   the user protocol.
  end note


  note over Responder
   The responder knows that this stream is called <b>stream A</b>
  end note

  ... <i>Continue negotiating another protocol</i> ...
else Responder does <i>not</i> supports stream-migration
  Initiator <- Responder: send back "na" for the stream-migration protocol (like multistream-select)
  Initiator <- Responder: Echo back ""<user-protocol-id>"" (as-in multistream select)
end

... <i>Nodes use the stream as normal<i> ...

== Stream Migration ==

note over Initiator, Responder: Migrate <b>Stream A</b> to <b>Stream B</b>

Initiator -> Responder: Open new stream on <b>Connection 2</b>. Call this <b>Stream B</b>

Initiator -> Responder: ""<stream-migration protocol id>/<this-stream-id>/from/<original-stream-id>""\ne.g. ""streamMigration/1.0.0/B/from/A""

Initiator <- Responder: <b>Stream B:</b> Ack Migrate

note over Responder
    Treat any ""EOF"" on <b>stream A</b> as a signal
    that it should continue reading on <b>stream B</b>
end note


note over Initiator
    Close <b>stream A</b> for writing.
    Will only write to <b>stream B</b> from now on.
end note

Initiator -> Responder: <b>Stream A:</b> ""EOF""

note over Responder
    When <i>Responder</i> reads ""EOF"" on <b>stream A</b>
    it will close <b>stream A</b> for writing.
    It will only write to <b>stream B</b> from now on.
end note

Initiator <- Responder: <b>Stream A:</b> ""EOF""

note over Initiator
    Treat any ""EOF"" on <b>stream A</b> as a signal
    that it should continue reading on <b>stream B</b>
end note

note over Initiator, Responder
    At this point <b>stream A</b> is closed for writing on
    both sides, and both sides have read up to ""EOF"".
    <b>stream A</b> has been fully migrated to <b>stream B</b>
end note

@enduml

@startuml stream-migration
skinparam sequenceMessageAlign center
entity Initiator
entity Responder


Initiator -> Responder: Open connection
... <i>Establish both sides support multistream-select</i> ...

Initiator -> Responder: Open multiplexed stream

Initiator -> Responder: Send ""<stream-migration protocol id>/<stream-id>""\ne.g. ""streamMigration/1.0.0/A""
Initiator -> Responder: Send ""<user-protocol-id>"" (as-in multistream select)

alt Responder supports stream-migration
  Initiator <- Responder: Echo back ""<user-protocol-id>"" (as-in multistream select)
  note over Initiator
   The initiator knows the peer supports stream-migration since it echoed back
   the user protocol.
  end note


  note over Responder
   The responder knows that this stream is called <b>stream A</b>
  end note

  ... <i>Continue negotiating another protocol</i> ...
else Responder does <i>not</i> supports stream-migration
  Initiator <- Responder: send back "na" for the stream-migration protocol (like multistream-select)
  Initiator <- Responder: Echo back ""<user-protocol-id>"" (as-in multistream select)
end

... <i>Nodes use the stream as normal<i> ...

== Stream Migration ==

note over Initiator, Responder: Migrate <b>Stream A</b> to <b>Stream B</b>

Initiator -> Responder: Open new stream on <b>Connection 2</b>. Call this <b>Stream B</b>

Initiator -> Responder: ""<stream-migration protocol id>/<this-stream-id>/from/<original-stream-id>""\ne.g. ""streamMigration/1.0.0/B/from/A""

Initiator <- Responder: <b>Stream B:</b> Ack Migrate

note over Responder
    Treat any ""EOF"" on <b>stream A</b> as a signal
    that it should continue reading on <b>stream B</b>
end note


note over Initiator
    Close <b>stream A</b> for writing.
    Will only write to <b>stream B</b> from now on.
end note

Initiator -> Responder: <b>Stream A:</b> ""EOF""

note over Responder
    When <i>Responder</i> reads ""EOF"" on <b>stream A</b>
    it will close <b>stream A</b> for writing.
    It will only write to <b>stream B</b> from now on.
end note

Initiator <- Responder: <b>Stream A:</b> ""EOF""

note over Initiator
    Treat any ""EOF"" on <b>stream A</b> as a signal
    that it should continue reading on <b>stream B</b>
end note

note over Initiator, Responder
    At this point <b>stream A</b> is closed for writing on
    both sides, and both sides have read up to ""EOF"".
    <b>stream A</b> has been fully migrated to <b>stream B</b>
end note

@enduml

PlantUML version 1.2021.12(Tue Oct 05 09:01:58 PDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>