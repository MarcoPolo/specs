<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="920px" preserveAspectRatio="none" style="width:854px;height:920px;background:#FFFFFF;" version="1.1" viewBox="0 0 854 920" width="854px" zoomAndPan="magnify"><defs><filter height="300%" id="f6xvxg8vjmnfo" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="157" y1="53.4883" y2="249.3516"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="157" x2="157" y1="249.3516" y2="290.3066"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="157" y1="290.3066" y2="862.5176"/><line style="stroke:#A80036;stroke-width:1.0;" x1="690" x2="690" y1="53.4883" y2="249.3516"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="690" x2="690" y1="249.3516" y2="290.3066"/><line style="stroke:#A80036;stroke-width:1.0;" x1="690" x2="690" y1="290.3066" y2="862.5176"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="127" y="50.5352">Initiator</text><ellipse cx="157" cy="21" fill="#FEFECE" filter="url(#f6xvxg8vjmnfo)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="145" x2="169" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="127" y="875.0527">Initiator</text><ellipse cx="157" cy="894.0059" fill="#FEFECE" filter="url(#f6xvxg8vjmnfo)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="145" x2="169" y1="908.0059" y2="908.0059"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="650" y="50.5352">Responder</text><ellipse cx="690" cy="21" fill="#FEFECE" filter="url(#f6xvxg8vjmnfo)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="678" x2="702" y1="35" y2="35"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="650" y="875.0527">Responder</text><ellipse cx="690" cy="894.0059" fill="#FEFECE" filter="url(#f6xvxg8vjmnfo)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/><line style="stroke:#A80036;stroke-width:2.0;" x1="678" x2="702" y1="908.0059" y2="908.0059"/><path d="M124,68.4883 L124,93.4883 L722,93.4883 L722,78.4883 L712,68.4883 L124,68.4883 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,68.4883 L712,78.4883 L722,78.4883 L712,68.4883 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311" x="261" y="86.0566">Assume both sides understand stream-migration</text><polygon fill="#A80036" points="678,120.1094,688,124.1094,678,128.1094,682,124.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="124.1094" y2="124.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="370" y="119.3672">Open connection</text><polygon fill="#A80036" points="678,149.4199,688,153.4199,678,157.4199,682,153.4199" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="153.4199" y2="153.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="344" y="148.6777">Open multiplexed stream</text><polygon fill="#A80036" points="678,178.7305,688,182.7305,678,186.7305,682,182.7305" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="182.7305" y2="182.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="169" y="177.9883">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="438" y="177.6646">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="678,208.041,688,212.041,678,216.041,682,212.041" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="212.041" y2="212.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="245" y="207.2988">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="264" x="279" y="206.9751">StreamMigration(type=Label(id=1))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="547" y="207.2988">message</text><polygon fill="#A80036" points="678,237.3516,688,241.3516,678,245.3516,682,241.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="241.3516" y2="241.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="259" x="294" y="236.6094">continue negotiating underlying protocol</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="337.5" y="273.9863"/><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="172" x="337.5" y="273.9863">Nodes use the stream as normal</text><text fill="#000000" font-family="sans-serif" font-size="11" font-style="italic" lengthAdjust="spacing" textLength="0" x="512.5" y="273.9863"/><rect fill="#EEEEEE" filter="url(#f6xvxg8vjmnfo)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="847" x="0" y="310.9619"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="847" y1="310.9619" y2="310.9619"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="847" y1="313.9619" y2="313.9619"/><rect fill="#EEEEEE" filter="url(#f6xvxg8vjmnfo)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="134" x="356.5" y="300.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="362.5" y="316.875">Stream Migration</text><path d="M124,338.6172 L124,363.6172 L722,363.6172 L722,348.6172 L712,338.6172 L124,338.6172 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,338.6172 L712,348.6172 L722,348.6172 L712,338.6172 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="320.5" y="356.1855">Migrate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="371.5" y="356.1855">Stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="435.5" y="356.1855">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="452.5" y="356.1855">Stream 2</text><polygon fill="#A80036" points="678,390.2383,688,394.2383,678,398.2383,682,394.2383" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="394.2383" y2="394.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="369" y="389.4961">Open new stream</text><polygon fill="#A80036" points="678,419.5488,688,423.5488,678,427.5488,682,423.5488" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="423.5488" y2="423.5488"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="169" y="418.8066">Negotiate stream-migration protocol with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="438" y="418.4829">&lt;stream-migration protocol id&gt;</text><polygon fill="#A80036" points="678,448.8594,688,452.8594,678,456.8594,682,452.8594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="452.8594" y2="452.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="171.5" y="448.1172">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="238.5" y="448.1172">Send</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="272.5" y="447.7935">StreamMigration(type=Migrate(id=2, from=1))</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="620.5" y="448.1172">message</text><polygon fill="#A80036" points="168,478.1699,158,482.1699,168,486.1699,164,482.1699" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="162" x2="689" y1="482.1699" y2="482.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="308" y="477.4277">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="375" y="477.4277">Send AckMigrate message</text><path d="M538,495.1699 L538,535.1699 L838,535.1699 L838,505.1699 L828,495.1699 L538,495.1699 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M828,495.1699 L828,505.1699 L838,505.1699 L828,495.1699 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="544" y="512.7383">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="606" y="512.4146">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="634" y="512.7383">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="654" y="512.7383">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="718" y="512.7383">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="544" y="528.0488">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="763" y="528.0488">stream 2</text><path d="M15,549.791 L15,589.791 L294,589.791 L294,559.791 L284,549.791 L15,549.791 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M284,549.791 L284,559.791 L294,559.791 L284,549.791 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="21" y="567.3594">Close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="60" y="567.3594">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="124" y="567.3594">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="21" y="582.6699">Will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="131" y="582.6699">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="195" y="582.6699">from now on.</text><polygon fill="#A80036" points="678,616.7227,688,620.7227,678,624.7227,682,620.7227" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="684" y1="620.7227" y2="620.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="378" y="615.9805">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="445" y="615.9805"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="445" y="615.6567">EOF</text><path d="M542,633.7227 L542,688.7227 L833,688.7227 L833,643.7227 L823,633.7227 L542,633.7227 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M823,633.7227 L823,643.7227 L833,643.7227 L823,633.7227 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="548" y="651.291">When</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="66" x="586" y="651.291">Responder</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="656" y="651.291">reads</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="694" y="650.9673">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="722" y="651.291">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="742" y="651.291">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="548" y="666.6016">it will close</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="624" y="666.6016">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="688" y="666.6016">for writing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="548" y="681.9121">It will only write to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="670" y="681.9121">stream 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="734" y="681.9121">from now on.</text><polygon fill="#A80036" points="168,715.9648,158,719.9648,168,723.9648,164,719.9648" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="162" x2="689" y1="719.9648" y2="719.9648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="378" y="715.2227">Stream 2:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="445" y="715.2227"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="445" y="714.8989">EOF</text><path d="M5,732.9648 L5,772.9648 L305,772.9648 L305,742.9648 L295,732.9648 L5,732.9648 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M295,732.9648 L295,742.9648 L305,742.9648 L295,732.9648 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="11" y="750.5332">Treat any</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="73" y="750.2095">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="16" x="101" y="750.5332">on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="121" y="750.5332">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="185" y="750.5332">as a signal</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="11" y="765.8438">that it should continue reading on</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="230" y="765.8438">stream 2</text><path d="M124,787.5859 L124,842.5859 L722,842.5859 L722,797.5859 L712,787.5859 L124,787.5859 " fill="#FBFB77" filter="url(#f6xvxg8vjmnfo)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M712,787.5859 L712,797.5859 L722,797.5859 L712,787.5859 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="266.5" y="805.1543">At this point</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="349.5" y="805.1543">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="413.5" y="805.1543">is closed for writing on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268" x="266.5" y="820.4648">both sides, and both sides have read up to</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="538.5" y="820.1411">EOF</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="562.5" y="820.4648">.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="266.5" y="835.7754">stream 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="330.5" y="835.7754">has been fully migrated to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="499.5" y="835.7754">stream 2</text><!--MD5=[43fb610fdd07328b05204a8a749cd982]
@startuml stream-migration
skinparam sequenceMessageAlign center
entity Initiator
entity Responder

note over Initiator, Responder: Assume both sides understand stream-migration

Initiator -> Responder: Open connection
Initiator -> Responder: Open multiplexed stream

Initiator -> Responder: Negotiate stream-migration protocol with ""<stream-migration protocol id>""

Initiator -> Responder: Send ""StreamMigration(type=Label(id=1))"" message

Initiator -> Responder: <i> continue negotiating underlying protocol </i>
... <i>Nodes use the stream as normal<i> ...

== Stream Migration ==

note over Initiator, Responder: Migrate <b>Stream 1</b> to <b>Stream 2</b>

Initiator -> Responder: Open new stream
Initiator -> Responder: Negotiate stream-migration protocol with ""<stream-migration protocol id>""

Initiator -> Responder: <b>Stream 2:</b> Send ""StreamMigration(type=Migrate(id=2, from=1))"" message

Initiator <- Responder: <b>Stream 2:</b> Send AckMigrate message

note over Responder
    Treat any ""EOF"" on <b>stream 1</b> as a signal
    that it should continue reading on <b>stream 2</b>
end note


note over Initiator
    Close <b>stream 1</b> for writing.
    Will only write to <b>stream 2</b> from now on.
end note

Initiator -> Responder: <b>Stream 2:</b> ""EOF""

note over Responder
    When <i>Responder</i> reads ""EOF"" on <b>stream 1</b>
    it will close <b>stream 1</b> for writing.
    It will only write to <b>stream 2</b> from now on.
end note

Initiator <- Responder: <b>Stream 2:</b> ""EOF""

note over Initiator
    Treat any ""EOF"" on <b>stream 1</b> as a signal
    that it should continue reading on <b>stream 2</b>
end note

note over Initiator, Responder
    At this point <b>stream 1</b> is closed for writing on
    both sides, and both sides have read up to ""EOF"".
    <b>stream 1</b> has been fully migrated to <b>stream 2</b>
end note

@enduml

PlantUML version 1.2021.12(Tue Oct 05 18:01:58 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>